<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Introduction Stable Diffusion is a deep learning, text-to-image model developed by Stability AI. It is primarily used to generate detailed images based on text prompts. The model belongs to the class of generative models called diffusion models, which iteratively denoise a random signal to produce an image. AUTOMATIC1111 refers to a popular web-based user interface (UI) implementation for interacting with Stable Diffusion. Developed by an individual or group under the pseudonym &amp;ldquo;AUTOMATIC1111&amp;rdquo;, it provides a robust and user-friendly way to utilize Stable Diffusion&amp;rsquo;s capabilities.'><title>How to run Stable Diffusion in VM on AMD GPU (AUTOMATIC1111 &#43; KVM &#43; GPU Passthrough)</title>

<link rel='canonical' href='http://localhost:1313/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/'>

<link rel="stylesheet" href="/scss/style.min.f9492f1b593f586197671599a91241c9d5199e42c2d23a91f5f34890c8f01f38.css"><meta property='og:title' content='How to run Stable Diffusion in VM on AMD GPU (AUTOMATIC1111 &#43; KVM &#43; GPU Passthrough)'>
<meta property='og:description' content='Introduction Stable Diffusion is a deep learning, text-to-image model developed by Stability AI. It is primarily used to generate detailed images based on text prompts. The model belongs to the class of generative models called diffusion models, which iteratively denoise a random signal to produce an image. AUTOMATIC1111 refers to a popular web-based user interface (UI) implementation for interacting with Stable Diffusion. Developed by an individual or group under the pseudonym &amp;ldquo;AUTOMATIC1111&amp;rdquo;, it provides a robust and user-friendly way to utilize Stable Diffusion&amp;rsquo;s capabilities.'>
<meta property='og:url' content='http://localhost:1313/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/'>
<meta property='og:site_name' content='The IT Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='AUTOMATIC1111' /><meta property='article:tag' content='Stable Diffusion' /><meta property='article:tag' content='KVM' /><meta property='article:tag' content='AMD' /><meta property='article:tag' content='ROCM' /><meta property='article:tag' content='GPU' /><meta property='article:tag' content='Virtio' /><meta property='article:tag' content='Ubuntu Server' /><meta property='article:published_time' content='2024-06-01T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-06-01T00:00:00&#43;00:00'/><meta property='og:image' content='http://localhost:1313/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/header.png' />
<meta name="twitter:title" content="How to run Stable Diffusion in VM on AMD GPU (AUTOMATIC1111 &#43; KVM &#43; GPU Passthrough)">
<meta name="twitter:description" content="Introduction Stable Diffusion is a deep learning, text-to-image model developed by Stability AI. It is primarily used to generate detailed images based on text prompts. The model belongs to the class of generative models called diffusion models, which iteratively denoise a random signal to produce an image. AUTOMATIC1111 refers to a popular web-based user interface (UI) implementation for interacting with Stable Diffusion. Developed by an individual or group under the pseudonym &amp;ldquo;AUTOMATIC1111&amp;rdquo;, it provides a robust and user-friendly way to utilize Stable Diffusion&amp;rsquo;s capabilities."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/header.png' />
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            localStorage.setItem(colorSchemeKey, "dark");
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/00017-1934920406-1_hu0cd6fab3aa04119128d42f705dfb9f8a_317861_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üíª</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">The IT Blog</a></h1>
            
            
            
            
            <h2 class="site-description">by ShiftHackZ</h2>
            
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/ShiftHackZ'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/moroz-dm-m'
                        target="_blank"
                        title="LinkedIn"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" />
  <path d="M8 11l0 5" />
  <path d="M8 8l0 .01" />
  <path d="M12 16l0 -5" />
  <path d="M16 16v-3a2 2 0 0 0 -4 0" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        

        <li >
            <a href='/projects/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M9.828 9.172a4 4 0 1 0 0 5.656 a10 10 0 0 0 2.172 -2.828a10 10 0 0 1 2.172 -2.828 a4 4 0 1 1 0 5.656a10 10 0 0 1 -2.172 -2.828a10 10 0 0 0 -2.172 -2.828" />
</svg>



                
                <span>My projects</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="http://localhost:1313/" selected>English</option>
                        
                            <option value="http://localhost:1313/uk/" >–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                        
                    </select>
                </li>
            
            
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/">
                <img src="/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/header_hu3aafa9004173c931941da8e2c440d12d_732838_800x0_resize_box_3.png"
                        srcset="/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/header_hu3aafa9004173c931941da8e2c440d12d_732838_800x0_resize_box_3.png 800w, /post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/header_hu3aafa9004173c931941da8e2c440d12d_732838_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="386" 
                        loading="lazy"
                        alt="Featured image of post How to run Stable Diffusion in VM on AMD GPU (AUTOMATIC1111 &#43; KVM &#43; GPU Passthrough)" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/linux/" >
                Linux
            </a>
        
            <a href="/categories/hardware/" >
                Hardware
            </a>
        
            <a href="/categories/artificial-intelligence/" >
                Artificial Intelligence
            </a>
        
            <a href="/categories/virtualization/" >
                Virtualization
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/">How to run Stable Diffusion in VM on AMD GPU (AUTOMATIC1111 &#43; KVM &#43; GPU Passthrough)</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">01.06.2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    4 minute read
                </time>
            </div>
        
    </footer>
    

    
        <footer class="article-translations">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



            <div>
                
                    <a href="http://localhost:1313/uk/post/%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-stable-diffusion-%D1%83-%D0%B2%D1%96%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%96%D0%B9-%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%96-%D0%BD%D0%B0-%D0%B2%D1%96%D0%B4%D0%B5%D0%BE%D0%BA%D0%B0%D1%80%D1%82%D1%96-amd-automatic1111--kvm--gpu-passthrough/" class="link">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</a>
                
            </div>
        </footer>
    
</div>
</header>

    <section class="article-content">
    
    
    <h2 id="introduction">Introduction</h2>
<p>Stable Diffusion is a deep learning, text-to-image model developed by Stability AI. It is primarily used to generate detailed images based on text prompts. The model belongs to the class of generative models called diffusion models, which iteratively denoise a random signal to produce an image. AUTOMATIC1111 refers to a popular web-based user interface (UI) implementation for interacting with Stable Diffusion. Developed by an individual or group under the pseudonym &ldquo;AUTOMATIC1111&rdquo;, it provides a robust and user-friendly way to utilize Stable Diffusion&rsquo;s capabilities.</p>
<h3 id="why-i-run-automatic1111-inside-vm">Why I run AUTOMATIC1111 inside VM</h3>
<p>In one of my previous articles I mentioned that I use dual AMD-GPU custom desktop system with Arch Linux as main host OS. Personally for me, running AUTOMATIC1111 inside a KVM-based virtual machine with AMD GPU passthrough offers several key benefits:</p>
<ol>
<li>
<p><strong>Portability</strong>. As I use Arch Linux as my main host OS on different computers it is sometimes can be tricky to manage dependencies that are required to run AUTOMATIC1111. For example, at the time of writing this article (02.06.2024), AUTOMATIC1111 requires Python 3.10 and the bleeding edge Python version in the official arch repositories is 3.12. In case of running AUTOMATIC1111 inside a VM I can setup the dependencies once inside that VM, and I don&rsquo;t have to worry about messing the dependencies on each Arch update.</p>
</li>
<li>
<p><strong>Snapshot and Restore</strong>. As I have a VM storage as single *.qcow2 file, I can backup it, transfer to my another machine or server in my homelab. It&rsquo;s also easy to keep my checkpoints, loras, etc inside a single VM, and in case I need to transfer AUTOMATIC1111 installation to another host machine, I need only to copy VM backup. There is no need to do the dependencies installation, models setup every time.</p>
</li>
</ol>
<h3 id="why-i-need-automatic1111">Why I need AUTOMATIC1111</h3>
<p><img src="https://github.com/ShiftHackZ/Stable-Diffusion-Android/raw/master/docs/assets/github-header-image.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>AUTOMATIC1111 software is crucial for me as I develop free and open source <a class="link" href="https://github.com/ShiftHackZ/Stable-Diffusion-Android"  target="_blank" rel="noopener"
    >SDAI - Stable Diffusion Android client application</a> that can connect to any AUTOMATIC1111 server or other supported AI Image generation provider. I need many different isolated AUTOMATIC1111 instances to perform testing of my android application.</p>
<h2 id="installation">Installation</h2>
<h3 id="create-a-new-linux-vm">Create a new Linux VM</h3>
<p>First we need to create a new Linux VM with GPU Passthrough of PCI devices to that VM. I already covered creation of VM in the article &ldquo;<a class="link" href="https://blog.moroz.cc/post/gpu-pci-passthrough-to-windows-kvm-on-arch-linux/#setup-a-new-vm-and-install-windows-1011"  target="_blank" rel="noopener"
    >GPU PCI passthrough to Windows KVM on Arch Linux</a>&rdquo;, but this time I will use <a class="link" href="https://releases.ubuntu.com/22.04/"  target="_blank" rel="noopener"
    >Ubuntu Sever 22.04 LTS</a> as a OS for Guest VM. I have chosen Ubuntu Server 22.04 for the guest OS because for the moment of writing this article (02.06.2024) this is the latest release that is supported by proprietary AMD ROCM driver that is needed to run AI on the power of GPU.</p>
<h3 id="update-the-os-packages">Update the OS packages</h3>
<p>After installing the OS first thing you need to do is to update the system packages to the latest available versions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt upgrade
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="install-needed-dependencies">Install needed dependencies</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt install -y git python3-pip python3-venv python3-dev libstdc++-12-dev libgl1-mesa-glx</span></span></code></pre></div>
<h3 id="install-amd-rocm-driver">Install AMD ROCM driver</h3>
<p>I used official instructions from the <a class="link" href="https://rocm.docs.amd.com/projects/install-on-linux/en/latest/tutorial/quick-start.html"  target="_blank" rel="noopener"
    >AMD documentation</a> to install the ROCM driver.</p>
<p>First, install headers and extras for the current kernel:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt install -y <span class="s2">&#34;linux-headers-</span><span class="k">$(</span>uname -r<span class="k">)</span><span class="s2">&#34;</span> <span class="s2">&#34;linux-modules-extra-</span><span class="k">$(</span>uname -r<span class="k">)</span><span class="s2">&#34;</span></span></span></code></pre></div>
<p>Then, ensure your current user is a part of <code>video</code> and <code>render</code> groups. To add the current user to the groups use command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo usermod -a -G render,video <span class="nv">$LOGNAME</span></span></span></code></pre></div>
<p>Download installer deb package and install it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">wget https://repo.radeon.com/amdgpu-install/6.1.1/ubuntu/jammy/amdgpu-install_6.1.60101-1_all.deb
</span></span><span class="line"><span class="cl">sudo dpkg -i amdgpu-install_6.1.60101-1_all.deb</span></span></code></pre></div>
<p>Install the DKMS module and rocm packages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install amdgpu-dkms rocm</span></span></code></pre></div>
<p>Finally, reboot the VM:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo reboot</span></span></code></pre></div>
<h3 id="install-automatic1111-software">Install AUTOMATIC1111 software</h3>
<p>The most easy and convinient way is just to clone the official git repository. After cloning, navigate to the cloned directory.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> stable-diffusion-webui</span></span></code></pre></div>
<p>Setup Python virtual environment:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">python3 -m venv venv
</span></span><span class="line"><span class="cl"><span class="nb">source</span> venv/bin/activate</span></span></code></pre></div>
<p>Install python dependencies needed by AUTOMATIC1111:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pip3 install -r requirements.txt</span></span></code></pre></div>
<p>Uninstall generic torch dependencies and replace them with ROCM:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pip3 uninstall torch torchvision
</span></span><span class="line"><span class="cl">pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm6.0</span></span></code></pre></div>
<h3 id="create-custom-automatic1111-launch-script">Create custom AUTOMATIC1111 launch script</h3>
<p>I will use nano to create a new file <code>nano launch.sh</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> venv/bin/activate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HSA_OVERRIDE_GFX_VERSION</span><span class="o">=</span>10.3.0
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HIP_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PYTORCH_HIP_ALLOC_CONF</span><span class="o">=</span>garbage_collection_threshold:0.8,max_split_size_mb:512
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python3 launch.py --api --listen --enable-insecure-extension-access --opt-sdp-attention
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then save the file <code>Ctrl + O</code> and exit nano <code>Ctrl + X</code>.</p>
<h3 id="launch-automatic1111">Launch AUTOMATIC1111</h3>
<p>Every time you need to launch AUTOMATIC1111 navigate to the cloned <code>stable-diffusion-webui</code> directory and launch created <code>launch.sh</code> script like in the following example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> stable-diffusion-webui
</span></span><span class="line"><span class="cl">bash launch.sh</span></span></code></pre></div>
<p>As the result, you will see that AUTOMATIC1111 running successfully.</p>
<p><img src="/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/a1111-launch.png"
	width="1047"
	height="395"
	srcset="/post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/a1111-launch_hu7767396bc0a300c4a77346294e8113f9_23785_480x0_resize_box_3.png 480w, /post/how-to-run-stable-diffusion-in-vm-on-amd-gpu-automatic1111--kvm--gpu-passthrough/a1111-launch_hu7767396bc0a300c4a77346294e8113f9_23785_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="Running AUTOMATIC1111 instance."
	
	
		class="gallery-image" 
		data-flex-grow="265"
		data-flex-basis="636px"
	
></p>
<h2 id="conclusion">Conclusion</h2>
<p>Stable Diffusion is a powerful model for generating images from text descriptions, and AUTOMATIC1111 is a user-friendly interface that makes it easier to use Stable Diffusion&rsquo;s capabilities effectively. Together, they enable a wide range of creative and practical applications in the realm of generative art and image synthesis. By leveraging a KVM-based virtual machine with AMD GPU passthrough, you can achieve a powerful, secure, and flexible environment for running AUTOMATIC1111 and harnessing the capabilities of Stable Diffusion efficiently.</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a class="link" href="https://releases.ubuntu.com/22.04/"  target="_blank" rel="noopener"
    >Ubuntu Sever 22.04 LTS Jammy</a></li>
<li><a class="link" href="https://rocm.docs.amd.com/projects/install-on-linux/en/latest/tutorial/quick-start.html"  target="_blank" rel="noopener"
    >AMD ROCM Documentation</a></li>
<li><a class="link" href="https://github.com/AUTOMATIC1111/stable-diffusion-webui"  target="_blank" rel="noopener"
    >AUTOMATIC1111</a></li>
<li><a class="link" href="https://github.com/ShiftHackZ/Stable-Diffusion-Android"  target="_blank" rel="noopener"
    >SDAI - Stable Diffusion Android client application</a></li>
<li><a class="link" href="https://gist.github.com/evshiron/8cf4de34aa01e217ce178b8ed54a2c43"  target="_blank" rel="noopener"
    >Custom stable-diffusion-webui launch script</a></li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/automatic1111/">AUTOMATIC1111</a>
        
            <a href="/tags/stable-diffusion/">Stable Diffusion</a>
        
            <a href="/tags/kvm/">KVM</a>
        
            <a href="/tags/amd/">AMD</a>
        
            <a href="/tags/rocm/">ROCM</a>
        
            <a href="/tags/gpu/">GPU</a>
        
            <a href="/tags/virtio/">Virtio</a>
        
            <a href="/tags/ubuntu-server/">Ubuntu Server</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/post/gpu-pci-passthrough-to-windows-kvm-on-arch-linux/">
        
        
            <div class="article-image">
                <img src="/post/gpu-pci-passthrough-to-windows-kvm-on-arch-linux/header.4cbc9527d35aee0d88851c8b34c4d218_hued49b8fc40a4ce925bd267fd9ac65523_97296_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post GPU PCI passthrough to Windows KVM on Arch Linux"
                        
                        data-hash="md5-TLyVJ9Na7g2IhRyLNMTSGA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">GPU PCI passthrough to Windows KVM on Arch Linux</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/how-to-install-kvm-on-arch-linux/">
        
        
            <div class="article-image">
                <img src="/post/how-to-install-kvm-on-arch-linux/header.20b50ea9aa0e9ad031e6dce695cc3b79_hu9582e9719e96abf49c172162d020cea7_78147_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post How to install KVM on Arch Linux"
                        
                        data-hash="md5-ILUOqaoOmtAx5tzmlcw7eQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">How to install KVM on Arch Linux</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/how-to-make-thinkpad-lte-modem-work-on-arch-linux-using-fcc-unlock/">
        
        
            <div class="article-image">
                <img src="/post/how-to-make-thinkpad-lte-modem-work-on-arch-linux-using-fcc-unlock/header.72792dba77904cd868ceaac404913421_hu2d109c230a8b683de6314808740ea101_247945_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post How to make ThinkPad LTE Modem work on Arch Linux using FCC unlock"
                        
                        data-hash="md5-cnktuneQTNhozqrEBJE0IQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">How to make ThinkPad LTE Modem work on Arch Linux using FCC unlock</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/assembling-a-pikvm-v2-device-for-remote-kvm-over-ip-control-of-a-computer-or-server/">
        
        
            <div class="article-image">
                <img src="/post/assembling-a-pikvm-v2-device-for-remote-kvm-over-ip-control-of-a-computer-or-server/header.6d6a0291a0418a1d58cc90f270165a8b_huaf7132429931ddcde60d8d9ee0a89d27_286083_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Assembling a PiKVM v2 device for remote KVM over IP control of a computer or server"
                        
                        data-hash="md5-bWoCkaBBih1YzJDycBZaiw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Assembling a PiKVM v2 device for remote KVM over IP control of a computer or server</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/listen-https-and-openvpn-server-on-same-443-port-using-haproxy-load-balancer/">
        
        
            <div class="article-image">
                <img src="/post/listen-https-and-openvpn-server-on-same-443-port-using-haproxy-load-balancer/header.64332b7f20e41333bff1516c3b20bd60_hu38aeca524a31a58e580a8f8774f7f217_36945_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Listen HTTPS and OpenVPN server on same 443 port using HAProxy load balancer"
                        
                        data-hash="md5-ZDMrfyDkEzO/8VFsOyC9YA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Listen HTTPS and OpenVPN server on same 443 port using HAProxy load balancer</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="blogmorozcc/blogmorozcc.github.io"
    data-repo-id="R_kgDOHsfYjw"
    data-category="General"
    data-category-id="DIC_kwDOHsfYj84CbRdO"
    data-mapping="url"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('noborder_dark');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2016 - 
        
        2024 | ShiftHackZ
    </section>
    
    <section class="powerby">
        
        
        All rights reserved.
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a>
      <ol>
        <li><a href="#why-i-run-automatic1111-inside-vm">Why I run AUTOMATIC1111 inside VM</a></li>
        <li><a href="#why-i-need-automatic1111">Why I need AUTOMATIC1111</a></li>
      </ol>
    </li>
    <li><a href="#installation">Installation</a>
      <ol>
        <li><a href="#create-a-new-linux-vm">Create a new Linux VM</a></li>
        <li><a href="#update-the-os-packages">Update the OS packages</a></li>
        <li><a href="#install-needed-dependencies">Install needed dependencies</a></li>
        <li><a href="#install-amd-rocm-driver">Install AMD ROCM driver</a></li>
        <li><a href="#install-automatic1111-software">Install AUTOMATIC1111 software</a></li>
        <li><a href="#create-custom-automatic1111-launch-script">Create custom AUTOMATIC1111 launch script</a></li>
        <li><a href="#launch-automatic1111">Launch AUTOMATIC1111</a></li>
      </ol>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#reference">Reference</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
