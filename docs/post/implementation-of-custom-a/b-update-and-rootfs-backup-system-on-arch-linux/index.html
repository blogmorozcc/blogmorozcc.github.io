<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Introduction An A/B update and backup system is a mechanism used primarily on Android devices to ensure safer and more reliable system updates. The approach involves having two partitions (A and B) for system data, allowing the device to switch between them during updates. Let&rsquo;s try to understand how it works and what makes it beneficial.
How A/B Update System Works Two System Partitions: Devices are set up with two copies of key partitions (A and B), which contain the operating system and related files. Only one partition is active at a time, meaning the device is always running on either A or B.
'><title>Implementation of custom A/B update and rootfs backup system on Arch Linux</title>

<link rel='canonical' href='https://blog.moroz.cc/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/'>

<link rel="stylesheet" href="/scss/style.min.f9492f1b593f586197671599a91241c9d5199e42c2d23a91f5f34890c8f01f38.css"><meta property='og:title' content='Implementation of custom A/B update and rootfs backup system on Arch Linux'>
<meta property='og:description' content='Introduction An A/B update and backup system is a mechanism used primarily on Android devices to ensure safer and more reliable system updates. The approach involves having two partitions (A and B) for system data, allowing the device to switch between them during updates. Let&rsquo;s try to understand how it works and what makes it beneficial.
How A/B Update System Works Two System Partitions: Devices are set up with two copies of key partitions (A and B), which contain the operating system and related files. Only one partition is active at a time, meaning the device is always running on either A or B.
'>
<meta property='og:url' content='https://blog.moroz.cc/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/'>
<meta property='og:site_name' content='The IT Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Linux' /><meta property='article:tag' content='Arch' /><meta property='article:tag' content='Backup' /><meta property='article:tag' content='Automation' /><meta property='article:published_time' content='2024-10-15T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-10-15T00:00:00&#43;00:00'/><meta property='og:image' content='https://blog.moroz.cc/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/header.png' />
<meta name="twitter:title" content="Implementation of custom A/B update and rootfs backup system on Arch Linux">
<meta name="twitter:description" content="Introduction An A/B update and backup system is a mechanism used primarily on Android devices to ensure safer and more reliable system updates. The approach involves having two partitions (A and B) for system data, allowing the device to switch between them during updates. Let&rsquo;s try to understand how it works and what makes it beneficial.
How A/B Update System Works Two System Partitions: Devices are set up with two copies of key partitions (A and B), which contain the operating system and related files. Only one partition is active at a time, meaning the device is always running on either A or B.
"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://blog.moroz.cc/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/header.png' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            localStorage.setItem(colorSchemeKey, "dark");
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/00017-1934920406-1_hu6352075014529694357.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üíª</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">The IT Blog</a></h1>
            
            
            
            
            <h2 class="site-description">by ShiftHackZ</h2>
            
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/ShiftHackZ'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/moroz-dm-m'
                        target="_blank"
                        title="LinkedIn"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" />
  <path d="M8 11l0 5" />
  <path d="M8 8l0 .01" />
  <path d="M12 16l0 -5" />
  <path d="M16 16v-3a2 2 0 0 0 -4 0" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        

        <li >
            <a href='/projects/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M9.828 9.172a4 4 0 1 0 0 5.656 a10 10 0 0 0 2.172 -2.828a10 10 0 0 1 2.172 -2.828 a4 4 0 1 1 0 5.656a10 10 0 0 1 -2.172 -2.828a10 10 0 0 0 -2.172 -2.828" />
</svg>



                
                <span>My projects</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://blog.moroz.cc/" selected>English</option>
                        
                            <option value="https://blog.moroz.cc/uk/" >–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                        
                    </select>
                </li>
            
            
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/">
                <img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/header_hu7005759659227955920.png"
                        srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/header_hu7005759659227955920.png 800w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/header_hu10542940553937841876.png 1600w"
                        width="800" 
                        height="454" 
                        loading="lazy"
                        alt="Featured image of post Implementation of custom A/B update and rootfs backup system on Arch Linux" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/linux/" >
                Linux
            </a>
        
            <a href="/categories/software/" >
                Software
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/">Implementation of custom A/B update and rootfs backup system on Arch Linux</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">15.10.2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    17 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h2 id="introduction">Introduction</h2>
<p>An A/B update and backup system is a mechanism used primarily on Android devices to ensure safer and more reliable system updates. The approach involves having two partitions (A and B) for system data, allowing the device to switch between them during updates. Let&rsquo;s try to understand how it works and what makes it beneficial.</p>
<h3 id="how-ab-update-system-works">How A/B Update System Works</h3>
<ul>
<li>
<p>Two System Partitions: Devices are set up with two copies of key partitions (A and B), which contain the operating system and related files. Only one partition is active at a time, meaning the device is always running on either A or B.</p>
</li>
<li>
<p>Non-Disruptive Updates: When an update is downloaded, it‚Äôs installed on the inactive partition (e.g., if you‚Äôre on A, it will be installed on B). This allows you to continue using the device while the update is being applied.</p>
</li>
<li>
<p>Safe Switching: Once the update is complete, the system reboots into the updated partition (in this case, B). If something goes wrong during the boot, the system will automatically switch back to the previously working partition (A). This rollback mechanism is crucial for preventing a device from becoming unusable due to a failed update.</p>
</li>
<li>
<p>Consistency and Speed: Updates are quicker because they don‚Äôt disrupt your device‚Äôs normal operations. You can use the device while the update is being installed in the background. Then, when you‚Äôre ready, you just need a quick reboot to switch partitions.</p>
</li>
</ul>
<h3 id="benefits-of-ab-update-system">Benefits of A/B Update System</h3>
<ul>
<li>
<p>Safety: If the new update is corrupted or incompatible, the device can revert to the other partition. This makes system updates more reliable.</p>
</li>
<li>
<p>Minimal Downtime: Updates are installed in the background, so you only need to reboot to complete the process. You don‚Äôt have to wait for the installation to happen during reboot.</p>
</li>
<li>
<p>Seamless Experience: The device can handle switching automatically, often without the user needing to take additional steps.</p>
</li>
</ul>
<h3 id="ab-backup-system">A/B Backup System</h3>
<p>Although A/B primarily refers to system updates, a similar concept can apply to backup systems. For instance, some backup tools might use alternate partitions or snapshots to store backups, ensuring that you have a fallback option in case of system failures.</p>
<p>This approach is especially used in modern <a class="link" href="https://source.android.com/docs/core/ota/ab"  target="_blank" rel="noopener"
    >Android system A/B OTA updates</a>, but it can also be found in other contexts where high reliability and system availability are crucial.</p>
<h2 id="benefits-of-ab-specific-to-arch-linux">Benefits of A/B specific to Arch Linux</h2>
<p>Implementing an A/B update system on Arch Linux could offer several advantages, particularly for users who value stability, reliability, and quick recovery options. Here‚Äôs why this approach might be beneficial for Arch Linux specifically:</p>
<h3 id="improved-system-stability">Improved System Stability</h3>
<ul>
<li>
<p>Rolling Release Model: Arch Linux is a rolling-release distribution, which means updates are frequent and bring both new features and potential changes that can lead to system instability. With an A/B system, you can update the inactive partition and quickly switch back to a stable setup if an issue arises.</p>
</li>
<li>
<p>Reliability: An A/B system can help maintain system uptime and stability by allowing quick rollback to a previously working state if an update introduces a bug or compatibility issue.</p>
</li>
</ul>
<h3 id="safety-in-testing-and-experimentation">Safety in Testing and Experimentation</h3>
<ul>
<li>
<p>Arch Users Are Often Power Users: Many Arch users like to customize and experiment with their setups. The A/B system would allow you to try new configurations or packages on one partition while keeping a safe, functional setup on the other. If something goes wrong, you can reboot into the stable environment without having to troubleshoot complex issues.</p>
</li>
<li>
<p>Easy System Recovery: With a backup partition always available, users can test experimental or non-standard updates (such as kernel patches or desktop environment changes) with less risk. If an update fails or breaks the system, you can boot into the untouched partition and keep working.</p>
</li>
</ul>
<h3 id="quicker-update-rollbacks">Quicker Update Rollbacks</h3>
<ul>
<li>
<p>Effortless Reversion: Arch doesn‚Äôt have an inherent rollback feature built-in, so reverting to previous versions can be tedious. An A/B system would allow for quick switching between versions with no need to manually downgrade packages or restore from backups.</p>
</li>
<li>
<p>Bootloader Integration: Since you use systemd-boot, the A/B update system could integrate well with this bootloader, allowing you to select which partition to boot into directly from the boot menu.</p>
</li>
</ul>
<h2 id="downside-of-ab-update-and-backup-systems">Downside of A/B update and backup systems</h2>
<p>The main downside of an A/B update and backup system is increase in disk space usage. An A/B system would require additional storage space, effectively doubling the space required for system partitions. For users with limited disk space, this could be a drawback.</p>
<h2 id="implementing-my-own-ab-update-and-backup-system">Implementing my own A/B update and backup system</h2>
<p>I inspired the idea of an A/B update and backup system approach for backups and OS updates from Android and some immutable GNU/Linux distributions. I daily drive Arch Linux on my two own personal computers and prefer to have the latest updates. But on the other side I want to make my system as reliable as possible, and in case update ocassionaly break my system - I want to have a way to quickly rollback without doing install and configuration from scratch.</p>
<h3 id="understanding-the-requirements">Understanding the requirements</h3>
<p>First of all, I came up with the basic requirements that my custom A/B update and backup system must have:</p>
<ol>
<li>Both A and B partitions should be bootable, including the ability to choose any partition (A or B) manually during boot.</li>
<li>Ability to use different kernel versions for both A or B partitions.</li>
<li>Only the root / partition should be copied during A/B update or backup procedure. I have /home on separate partition and it should be untouched during backup process.</li>
<li>Solution should be compatible with LUKS encryption for security.</li>
<li>I want to have a single script for backup and restore operations (copy A to B, and copy B to A).</li>
<li>Script should be able to detect the source and destination partitions automatically, without providing additional arguments.</li>
</ol>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/scheme.png"
	width="1097"
	height="1143"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/scheme_hu18026895704027529802.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/scheme_hu4528006048314213157.png 1024w"
	loading="lazy"
	
		alt="A/B update and backup system principal mechanism"
	
	
		class="gallery-image" 
		data-flex-grow="95"
		data-flex-basis="230px"
	
></p>
<h3 id="choosing-components">Choosing components</h3>
<p>After understanding the requirements, the next important step is to find the right components that are able to meet those requirements and allow to implement the system. I have chosen <code>rsync</code> utility for doing backups as it is ideal for regular and incremental backups. It only copies changed files, making it efficient and faster for repeat backups. You can also easily exclude certain directories (like /home and /boot) and maintain a backup that is ready to be restored at the file level.</p>
<h3 id="partitioning-disk">Partitioning disk</h3>
<p>I already had a working Arch Linux system with configured LUKS encrytion and separate partitions for root (<code>/</code>) and home (<code>/home</code>). For more details you can check my <a class="link" href="https://blog.moroz.cc/post/arch-linux-install-guide-uefi--encrypted-lvm/"  target="_blank" rel="noopener"
    >Arch Linux install guide (UEFI + encrypted LVM)</a>.</p>
<p>So I needed to shrink the <code>/home</code> logical volume and create the second logical volume for the B root partition. My main root logical volume is 50Gb, so the second one should be exactly the same size.</p>
<p>This step should not be perform directly from my installed Arch system, because we need to perform the shrink operation. I used Arch Linux live install media for all the partitioning operations.</p>
<h4 id="unlock-the-luks-container">Unlock the LUKS container.</h4>
<p>I have encrypted LUKS container on <code>/dev/nvme0n1p2</code>, so first need to decrypt it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cryptsetup luksOpen /dev/nvme0n1p2 luks</span></span></code></pre></div>
<h4 id="shrink-the-home-logical-volume">Shrink the home logical volume</h4>
<p>In my case the volume group is named as <code>vg0</code> and contains a logical volume <code>lv_home</code> for the <code>/home</code> partition. The full path to the home logical volume in my case is <code>/dev/mapper/vg0-lv_home</code>. It needs to be shrinked in 50Gb amount in size, so there will be enough space for the second root partition. This can be performed with the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">lvresize -L -50G /dev/mapper/vg0-lv_home</span></span></code></pre></div>
<p>After the shrink operation it is also recommended to run <code>resize2fs</code> and <code>e2fsck</code> to ensure that filesystem is healthy and resized correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">resize2fs /dev/mapper/vg0-lv_home
</span></span><span class="line"><span class="cl">e2fsck -f /dev/mapper/vg0-lv_home</span></span></code></pre></div>
<h4 id="create-a-second-root-partition">Create a second root partition</h4>
<p>The last step of partitioning is to create a second &ldquo;B&rdquo; root partition. I decided to name the volume as <code>lv_root_2</code>, so the command is the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">lvcreate -L 50G -n lv_root_2 vg0</span></span></code></pre></div>
<p>Then the created partition should be formatted with exactly the same filesystem like already existing root partition. I already use ext4 filesystem, so the &ldquo;B&rdquo; root partition also should have ext4 filesystem.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkfs.ext4 /dev/mapper/lv_root_2</span></span></code></pre></div>
<p>Finally, the new partition layout of the system looks like this:</p>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/partitions.png"
	width="1039"
	height="500"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/partitions_hu7558437358515381162.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/partitions_hu11048232625777182021.png 1024w"
	loading="lazy"
	
		alt="A/B update and backup system partitions, logical volumes layout."
	
	
		class="gallery-image" 
		data-flex-grow="207"
		data-flex-basis="498px"
	
></p>
<h3 id="configure-bootloader">Configure bootloader</h3>
<p>In my case, I already use <code>systemd-boot</code> bootloader for my Arch Linux setup. It perfectly meets the requirements, as it allows booting different kernels. So to make the bootloader boot different kernels for different partitions (either &ldquo;A&rdquo; or &ldquo;B&rdquo;) the existing boot entries for partition &ldquo;A&rdquo; should be duplicated and modified to use with partition B.</p>
<p>The boot loader entries are stored at <code>/boot/loader/entries</code> directory, for ease of use navigate with <code>cd</code> into it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> /boot/loader/entries</span></span></code></pre></div>
<p>Then let&rsquo;s see what bootloader entries do we have:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ls -al</span></span></code></pre></div>
<p>I have two bootloader entries for existing parition &ldquo;A&rdquo; for loading <code>linux-zen</code> and <code>linux-lts</code> kernels that are stored in files <code>arch-zen.conf</code> and <code>arch-lts.conf</code> respectively. If you are using only one kernel version you will probaly have only one bootloader entry.</p>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot1.png"
	width="1039"
	height="500"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot1_hu4785233378607969330.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot1_hu15724962336650974305.png 1024w"
	loading="lazy"
	
		alt="Existing bootloader entries for partition &ldquo;A&rdquo;."
	
	
		class="gallery-image" 
		data-flex-grow="207"
		data-flex-basis="498px"
	
></p>
<p>For convenience it is better to rename them to <code>arch-zen-a.conf</code> and <code>arch-lts-a.conf</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo mv arch-zen.conf arch-zen-a.conf
</span></span><span class="line"><span class="cl">sudo mv arch-lts.conf arch-lts-a.conf</span></span></code></pre></div>
<p>After that I used <code>sudo nano arch-zen-a.conf</code> and <code>sudo nano arch-lts-a.conf</code> to modify this two files, added prefix <code>[Partition A]</code> to both titles that allows to understand what partition is used for the boot option.</p>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-lts-a.png"
	width="1194"
	height="500"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-lts-a_hu6673478298592396111.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-lts-a_hu14155926419589777046.png 1024w"
	loading="lazy"
	
		alt="Boot entry for LTS kernel on partition &ldquo;A&rdquo;."
	
	
		class="gallery-image" 
		data-flex-grow="238"
		data-flex-basis="573px"
	
>
<img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-zen-a.png"
	width="1194"
	height="500"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-zen-a_hu1108977642596772464.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-zen-a_hu15697669330591279989.png 1024w"
	loading="lazy"
	
		alt="Boot entry for ZEN kernel on partition &ldquo;A&rdquo;."
	
	
		class="gallery-image" 
		data-flex-grow="238"
		data-flex-basis="573px"
	
></p>
<p>Next both for of the files <code>arch-zen-a.conf</code> and <code>arch-lts-a.conf</code> should be duplicated for partition &ldquo;B&rdquo;, it can be achieved by making a copy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo cp arch-zen-a.conf arch-zen-b.conf
</span></span><span class="line"><span class="cl">sudo cp arch-lts-a.conf arch-lts-b.conf</span></span></code></pre></div>
<p>Than use similar command for &ldquo;B&rdquo; voluem entries <code>sudo nano arch-zen-b.conf</code>, <code>sudo nano arch-lts-b.conf</code> to change the title from &ldquo;[Partition A]&rdquo; to &ldquo;[Partition B]&rdquo; and change root partition from <code>/dev/vg0/lv_root</code> to <code>/dev/vg0/lv_root_2</code> in both of the files.</p>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-lts-b.png"
	width="1194"
	height="500"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-lts-b_hu8493241458509209425.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-lts-b_hu13539187266101592348.png 1024w"
	loading="lazy"
	
		alt="Boot entry for LTS kernel on partition &ldquo;B&rdquo;."
	
	
		class="gallery-image" 
		data-flex-grow="238"
		data-flex-basis="573px"
	
>
<img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-zen-b.png"
	width="1194"
	height="500"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-zen-b_hu11949643183411468776.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot-zen-b_hu7787071308164298950.png 1024w"
	loading="lazy"
	
		alt="Boot entry for ZEN kernel on partition &ldquo;B&rdquo;."
	
	
		class="gallery-image" 
		data-flex-grow="238"
		data-flex-basis="573px"
	
></p>
<p>Finally the bootloader entries directory will look exactly like this for my usecase:</p>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot2.png"
	width="1034"
	height="500"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot2_hu14462101249319033462.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/boot2_hu15424265614249234587.png 1024w"
	loading="lazy"
	
		alt="Final structure of bootloader entries for partitions &ldquo;A&rdquo; and &ldquo;B&rdquo;."
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="496px"
	
></p>
<h3 id="configure-fstab">Configure fstab</h3>
<p>The fstab (File System Table) is a configuration file in Unix-like operating systems (like Linux) that defines how disk partitions, storage devices, and other file systems should be mounted at boot time. The file is located at <code>/etc/fstab</code> and is read by the system during the boot process.</p>
<p>For different root partitions &ldquo;A&rdquo; and &ldquo;B&rdquo; there will be different UUIDs for main and backup root partition:</p>
<ul>
<li>The main root partition is mounted at <code>/</code> mountpoint.</li>
<li>I defined that the backup root partition will be mounted at <code>/mnt/root</code>.</li>
</ul>
<p>Considering that there are &ldquo;A&rdquo; (lv_root) and &ldquo;B&rdquo; (lv_root_2) partitions, there are 2 possible scenarios:</p>
<ul>
<li>
<p>If OS is booted from &ldquo;A&rdquo;:</p>
<ul>
<li>the <code>/</code> is <code>lv_root</code> volume;</li>
<li>the <code>/mnt/root</code> is <code>lv_root_2</code>;</li>
<li>during the backup operation &ldquo;A&rdquo; will be copied/restored to &ldquo;B&rdquo;.</li>
</ul>
</li>
<li>
<p>If OS is booted from &ldquo;B&rdquo;:</p>
<ul>
<li>the <code>/</code> is <code>lv_root_2</code> volume;</li>
<li>the <code>/mnt/root</code> is <code>lv_root</code>;</li>
<li>during the backup operation &ldquo;B&rdquo; will be copied/restored to &ldquo;A&rdquo;.</li>
</ul>
</li>
</ul>
<p>I ended up with a solution of having different <code>fstab</code> files for &ldquo;A&rdquo; and &ldquo;B&rdquo; partition (<code>fstabA</code> and <code>fstabB</code> respectively), and it will be responsibility of the backup script to replace the main <code>fstab</code> file with either <code>fstabA</code> or <code>fstabB</code> depending on the scenario described above.</p>
<p>First of all there is need to identify UUIDs of <code>lv_root</code> and <code>lv_root_2</code> for fstab:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo blkid /dev/mapper/vg0-lv_root
</span></span><span class="line"><span class="cl">sudo blkid /dev/mapper/vg0-lv_root_2</span></span></code></pre></div>
<p>To sum up, in my case UUIDs are:</p>
<ul>
<li>For partition &ldquo;A&rdquo; (lv_root) - <code>afb5ef09-0dd9-4002-977c-dd4d26782d05</code></li>
<li>For partition &ldquo;B&rdquo; (lv_root_2) - <code>9e3adc66-842f-4bec-aba0-85414eab7a07</code></li>
</ul>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/blkid.png"
	width="1042"
	height="440"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/blkid_hu8883179688405949836.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/blkid_hu10247167299147494616.png 1024w"
	loading="lazy"
	
		alt="Identifying UUIDs of &ldquo;A&rdquo; and &ldquo;B&rdquo;."
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="568px"
	
></p>
<p>Next, have a look at the original <code>/etc/fstab</code> file on my system:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_root</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>afb5ef09-0dd9-4002-977c-dd4d26782d05       /               ext4            rw,relatime     <span class="m">0</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_home</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>911cf69d-2ecb-4f2f-a9d5-491f44418922       /home           ext4            rw,relatime     <span class="m">0</span> <span class="m">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The partition &ldquo;A&rdquo; is already defined in it, so the partition B should be added by corresponding UUID, and the final look of the modified <code>/etc/fstab</code> file is the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_root</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>afb5ef09-0dd9-4002-977c-dd4d26782d05       /               ext4            rw,relatime     <span class="m">0</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_home</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>911cf69d-2ecb-4f2f-a9d5-491f44418922       /home           ext4            rw,relatime     <span class="m">0</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_root_2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>9e3adc66-842f-4bec-aba0-85414eab7a07       /mnt/root       ext4            rw,relatime     <span class="m">0</span> <span class="m">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The next step is to make 2 copies of <code>/etc/fstab</code> file to <code>/etc/fstabA</code> and <code>/etc/fstabB</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo cp /etc/fstab /etc/fstabA
</span></span><span class="line"><span class="cl">sudo cp /etc/fstab /etc/fstabB</span></span></code></pre></div>
<p>After duplicating the files, <code>fstabA</code> file is correct (as it has &ldquo;A&rdquo; partiton as root), but in <code>fstabB</code> file the partitions should be changed, so partition &ldquo;B&rdquo; is <code>/</code>, and &ldquo;A&rdquo; is <code>/mnt/root</code>. It is easy to do by just swapping UUIDs for corresponding mount in <code>/etc/fstabB</code> file, so the final look of the file is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_root_2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>9e3adc66-842f-4bec-aba0-85414eab7a07       /               ext4            rw,relatime     <span class="m">0</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_home</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>911cf69d-2ecb-4f2f-a9d5-491f44418922       /home           ext4            rw,relatime     <span class="m">0</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/vg0-lv_root_2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>afb5ef09-0dd9-4002-977c-dd4d26782d05       /mnt/root       ext4            rw,relatime     <span class="m">0</span> <span class="m">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After all the modifications are done it is recommended to reboot the computer, and make sure all partitions can be correctly mounted.</p>
<h3 id="make-partitions-identifiable">Make partitions identifiable</h3>
<p>One of the requirements for the backup script is to have it automatically detect the what is the currently used root partition, and what is the backup partition. To make the partitions identifiable, I decided to keep it simple and just create a text file <code>rootid</code> at the root of each partition, which contains corresponding partition letter (can be either &ldquo;A&rdquo; or &ldquo;B&rdquo;).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo <span class="nb">echo</span> <span class="s2">&#34;A&#34;</span> &gt;&gt; /rootid
</span></span><span class="line"><span class="cl">sudo <span class="nb">echo</span> <span class="s2">&#34;B&#34;</span> &gt;&gt; /mnt/root/rootid</span></span></code></pre></div>
<p>As the result, script will be able to read 2 files <code>/rootid</code> and <code>/mnt/rootid</code> and explicitly detect what partition is used as root and backup.</p>
<p><img src="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/rootid.png"
	width="1042"
	height="440"
	srcset="/post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/rootid_hu10764027515167526504.png 480w, /post/implementation-of-custom-a/b-update-and-rootfs-backup-system-on-arch-linux/rootid_hu10582134314316273040.png 1024w"
	loading="lazy"
	
		alt="Identifying &ldquo;A&rdquo; and &ldquo;B&rdquo; labels."
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="568px"
	
></p>
<h3 id="implementing-backup-script">Implementing backup script</h3>
<p>To properly make a working bootable backup the script should implement the following steps:</p>
<ol>
<li>Identify the root and backup partition.</li>
<li>Determine the operation mode by identified partitions, the possible values are:</li>
</ol>
<ul>
<li>&ldquo;AB&rdquo; - when partition &ldquo;A&rdquo; is booted and should be copied to &ldquo;B&rdquo;.</li>
<li>&ldquo;BA&rdquo; - when partition &ldquo;B&rdquo; is booted and should be copied to &ldquo;A&rdquo;.</li>
</ul>
<ol start="3">
<li>Perform the full backup for current root partition to backup partition using <code>rsync</code></li>
<li>Replace the <code>fstab</code> file on backup partition with the correct variant:</li>
</ol>
<ul>
<li>for the &ldquo;AB&rdquo; mode use <code>fstabB</code>.</li>
<li>for the &ldquo;BA&rdquo; mode use <code>fstabA</code>.</li>
</ul>
<ol start="5">
<li>Create default linux root filesystem symlinks on the backup root partition.</li>
</ol>
<p>Let&rsquo;s do the step by step implementation of each operation.</p>
<h4 id="identify-partitions-and-operation-mode">Identify partitions and operation mode</h4>
<p>It is straightforward and requires reading <code>/rootid</code> and <code>/mnt/root/rootid</code> files, and the use string concat to determine the operation mode:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">boot_id</span><span class="o">=</span><span class="k">$(</span>cat /rootid<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">backup_id</span><span class="o">=</span><span class="k">$(</span>cat /mnt/root/rootid<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">mode</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">boot_id</span><span class="si">}${</span><span class="nv">backup_id</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="perform-the-rsync-backup">Perform the rsync backup</h4>
<p>At this point I wrote <code>rsync</code> based command that is designed to backup mirror the root file system <code>/</code> to <code>/mnt/root</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">rsync -aHAXiv --progress --inplace --delete --exclude<span class="o">={</span><span class="s2">&#34;/boot&#34;</span>,<span class="s2">&#34;/home&#34;</span>,<span class="s2">&#34;/dev&#34;</span>,<span class="s2">&#34;/proc&#34;</span>,<span class="s2">&#34;/sys&#34;</span>,<span class="s2">&#34;/tmp&#34;</span>,<span class="s2">&#34;/run&#34;</span>,<span class="s2">&#34;/mnt&#34;</span>,<span class="s2">&#34;/media&#34;</span>,<span class="s2">&#34;/lost+found&#34;</span>,<span class="s2">&#34;/rootid&#34;</span>,<span class="s2">&#34;/bin&#34;</span>,<span class="s2">&#34;/lib&#34;</span>,<span class="s2">&#34;/lib64&#34;</span>,<span class="s2">&#34;/sbin&#34;</span><span class="o">}</span> / /mnt/root
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s break down each option to understand what it does and why:</p>
<ul>
<li><code>-a</code> (Archive Mode): Enables archive mode, which is a combination of options <code>-rlptgoD</code>. It ensures that:
<ul>
<li>Recursive <code>-r</code>: The command will copy directories recursively.</li>
<li>Links <code>-l</code>: Symbolic links are copied as symbolic links.</li>
<li>Permissions <code>-p</code>: Preserves file permissions.</li>
<li>Modification Times <code>-t</code>: Keeps original file modification times.</li>
<li>Group <code>-g</code>: Maintains group ownership.</li>
<li>Owner <code>-o</code>: Retains owner information (requires root privileges).</li>
<li>Devices <code>-D</code>: Preserves device and special files.</li>
</ul>
</li>
<li><code>-H</code>: Preserves hard links.</li>
<li><code>-A</code>: Preserves ACLs (Access Control Lists), which define more granular permissions than standard file permissions.</li>
<li><code>-X</code>: Preserves extended attributes, which can contain metadata for certain files and directories.</li>
<li><code>-i</code>: Displays a detailed list of changes for each file, providing more visibility into the operation.</li>
<li><code>-v</code>: Increases verbosity, giving you information about the files being transferred.</li>
<li><code>--progress</code>: Shows progress for each file during the transfer, useful for monitoring long operations.</li>
<li><code>--inplace</code>: Updates destination files in place, rather than creating a temporary file and moving it into place. This is useful for large files or if disk space is limited.</li>
<li><code>--delete</code>: Deletes files in the destination (/mnt/root) that no longer exist in the source (/). This makes the destination a true mirror of the source by removing any extra files.</li>
<li><code>--exclude={&quot;/boot&quot;,&quot;/home&quot;,&quot;/dev&quot;,&quot;/proc&quot;,&quot;/sys&quot;,&quot;/tmp&quot;,&quot;/run&quot;,&quot;/mnt&quot;,&quot;/media&quot;,&quot;/lost+found&quot;,&quot;/rootid&quot;,&quot;/bin&quot;,&quot;/lib&quot;,&quot;/lib64&quot;,&quot;/sbin&quot;}</code>: Excludes certain directories from being copied:
<ul>
<li><code>/boot</code>: Boot-related files, which may not be necessary for the backup, especially if you‚Äôre using a separate /boot partition.</li>
<li><code>/home</code>: User data, which might be backed up separately or is irrelevant for a root system backup.</li>
<li><code>/dev</code>: Device files that dynamically represent hardware (e.g., /dev/sda), which do not need to be backed up.</li>
<li><code>/proc</code> and <code>/sys</code>: Virtual filesystems representing system and process information, populated by the kernel at runtime and not meant to be copied.</li>
<li><code>/tmp</code>: Temporary files, which don‚Äôt need to be included in a backup.</li>
<li><code>/run</code>: Runtime data, which is also dynamically generated at boot.</li>
<li><code>/mnt</code> and <code>/media</code>: These are typically used for mounting other filesystems, which do not need to be part of a root system backup.</li>
<li><code>/lost+found</code>: Contains files recovered from file system errors; not necessary for a root backup.</li>
<li><code>/rootid</code>: Identifier file for root and backup partitions.</li>
<li><code>/bin</code>, <code>/lib</code>, <code>/lib64</code>, and <code>/sbin</code>: On modern Linux system those are symlinks and not the directories, so I decided to exclide them and make symlinks manually after backup.</li>
</ul>
</li>
</ul>
<h4 id="replace-the-fstab-file">Replace the fstab file</h4>
<p>This is also kind of straightforward step that requires checking for the operation mode and replacing the <code>/mnt/root/etc/fstab/</code> file according to the rules:</p>
<ul>
<li>for the &ldquo;AB&rdquo; mode use <code>/mnt/root/etc/fstabB</code>.</li>
<li>for the &ldquo;BA&rdquo; mode use <code>/mnt/root/etc/fstabA</code>.</li>
</ul>
<p>The bash script snippet for this is the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">fstab_path</span><span class="o">=</span><span class="s2">&#34;/mnt/root/etc/fstab&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$mode</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;AB&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Patching fstab for AB mode...&#34;</span>
</span></span><span class="line"><span class="cl">    rm /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl">    cp /mnt/root/etc/fstabB /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$mode</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;BA&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Patching fstab for BA mode...&#34;</span>
</span></span><span class="line"><span class="cl">    rm /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl">    cp /mnt/root/etc/fstabA /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Error: Unknown mode &#39;</span><span class="nv">$mode</span><span class="s2">&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="create-linux-filesystem-symlinks">Create linux filesystem symlinks</h4>
<p>On many modern Linux distributions, including Arch Linux, <code>/bin</code>, <code>/lib</code>, <code>/lib64</code>, and <code>/sbin</code> are symbolic links, rather than separate directories. This change is part of the move towards a simplified filesystem layout that merges <code>/bin</code>, <code>/lib</code>, and <code>/sbin</code> with their counterparts in <code>/usr</code>:</p>
<ul>
<li><code>/bin</code> ‚Üí <code>/usr/bin</code></li>
<li><code>/lib</code> ‚Üí <code>/usr/lib</code></li>
<li><code>/lib64</code> ‚Üí <code>/usr/lib64</code></li>
<li><code>/sbin</code> ‚Üí <code>/usr/sbin</code></li>
</ul>
<p>This unification helps streamline the filesystem by centralizing executables and libraries within the /usr directory, reducing redundancy and simplifying maintenance.</p>
<p>To create the symlinks after the backup was performed, this command snippet should be used:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;/bin -&gt; /mnt/root/bin&#34;</span>
</span></span><span class="line"><span class="cl">ln -s usr/bin /mnt/root/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;/lib -&gt; /mnt/root/lib&#34;</span>
</span></span><span class="line"><span class="cl">ln -s usr/lib /mnt/root/lib
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;/lib -&gt; /mnt/root/lib64&#34;</span>
</span></span><span class="line"><span class="cl">ln -s usr/lib /mnt/root/lib64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;/bin -&gt; /mnt/root/sbin&#34;</span>
</span></span><span class="line"><span class="cl">ln -s usr/bin /mnt/root/sbin
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="final-script-version">Final script version</h4>
<p>Finally I added some verbose logging messages and checks to the script to make it more stable and user-friendly. It is meant to be executed with sudo privileges, because it is making a full copy of root filesystem. The final version of the script is placed in <code>/opt/rootbackup.sh</code> and looks like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Starting backup script...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 1: Read the content of /rootid and /mnt/root/rootid</span>
</span></span><span class="line"><span class="cl"><span class="nv">boot_id</span><span class="o">=</span><span class="k">$(</span>cat /rootid<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">backup_id</span><span class="o">=</span><span class="k">$(</span>cat /mnt/root/rootid<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">mode</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">boot_id</span><span class="si">}${</span><span class="nv">backup_id</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Boot partition ID: </span><span class="nv">$boot_id</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Backup partition ID: </span><span class="nv">$backup_id</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Operation mode: </span><span class="nv">$mode</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 2: Perform the rsync backup with progress and verbosity</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Starting rsync backup from / to /mnt/root...&#34;</span>
</span></span><span class="line"><span class="cl">rsync -aHAXiv --progress --inplace --delete --exclude<span class="o">={</span><span class="s2">&#34;/boot&#34;</span>,<span class="s2">&#34;/home&#34;</span>,<span class="s2">&#34;/dev&#34;</span>,<span class="s2">&#34;/proc&#34;</span>,<span class="s2">&#34;/sys&#34;</span>,<span class="s2">&#34;/tmp&#34;</span>,<span class="s2">&#34;/run&#34;</span>,<span class="s2">&#34;/mnt&#34;</span>,<span class="s2">&#34;/media&#34;</span>,<span class="s2">&#34;/lost+found&#34;</span>,<span class="s2">&#34;/rootid&#34;</span>,<span class="s2">&#34;/bin&#34;</span>,<span class="s2">&#34;/lib&#34;</span>,<span class="s2">&#34;/lib64&#34;</span>,<span class="s2">&#34;/sbin&#34;</span><span class="o">}</span> / /mnt/root
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Backup was successful.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Path to the fstab file</span>
</span></span><span class="line"><span class="cl">    <span class="nv">fstab_path</span><span class="o">=</span><span class="s2">&#34;/mnt/root/etc/fstab&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$mode</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;AB&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Patching fstab for AB mode...&#34;</span>
</span></span><span class="line"><span class="cl">        rm /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl">        cp /mnt/root/etc/fstabB /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$mode</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;BA&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Patching fstab for BA mode...&#34;</span>
</span></span><span class="line"><span class="cl">        rm /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl">        cp /mnt/root/etc/fstabA /mnt/root/etc/fstab
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Error: Unknown mode &#39;</span><span class="nv">$mode</span><span class="s2">&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Final output to confirm changes</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Successfully updated /mnt/root/etc/fstab.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Updated fstab contents:&#34;</span>
</span></span><span class="line"><span class="cl">    cat <span class="s2">&#34;</span><span class="nv">$fstab_path</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Links creation</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating symlinks:&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    rm /mnt/root/bin
</span></span><span class="line"><span class="cl">    rm /mnt/root/lib
</span></span><span class="line"><span class="cl">    rm /mnt/root/lib64
</span></span><span class="line"><span class="cl">    rm /mnt/root/sbin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;/bin -&gt; /mnt/root/bin&#34;</span>
</span></span><span class="line"><span class="cl">    ln -s usr/bin /mnt/root/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;/lib -&gt; /mnt/root/lib&#34;</span>
</span></span><span class="line"><span class="cl">    ln -s usr/lib /mnt/root/lib
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;/lib -&gt; /mnt/root/lib64&#34;</span>
</span></span><span class="line"><span class="cl">    ln -s usr/lib /mnt/root/lib64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;/bin -&gt; /mnt/root/sbin&#34;</span>
</span></span><span class="line"><span class="cl">    ln -s usr/bin /mnt/root/sbin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Backup failed with rsync. Exiting.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Backup script completed.&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="running-updates">Running updates</h3>
<p>After implementing all the steps for the A/B update and backup system, the typical update process is the following:</p>
<ol>
<li>Run the backup script: <code>sudo /opt/rootbackup.sh</code>.</li>
<li>Do the full system update: <code>sudo pacman -Syu</code></li>
</ol>
<h3 id="conclusion">Conclusion</h3>
<p>Finally I created a custom A/B update and backup system that:</p>
<ul>
<li>Detects which root partition you are currently using (Partition A or B).</li>
<li>Backs up the active root partition to the alternate root partition using rsync, ensuring that changes in your main root partition are mirrored to the backup partition.</li>
<li>Updates /etc/fstab on the backup partition to prepare it for booting, with the correct root partition and mount points.
Efficient Incremental Backup with Rsync:</li>
</ul>
<p>The script uses rsync to perform an incremental backup, which only copies changed files and allows for the <code>--inplace</code> option to save disk space during backup. Additionally, we exclude directories like <code>/home</code>, <code>/boot</code>, and others that don‚Äôt need to be part of the backup.
This approach ensures that the backup partition remains an up-to-date, bootable copy of your main system, while saving on both time and storage space.</p>
<p>With this setup, I have both peace of mind and flexibility. I can continue working on my system without worrying about software updates or configuration changes that might lead to a broken setup. And in the event of a problem, I have a ready-to-go recovery partition that will minimize downtime and restore your productivity quickly!</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/linux/">Linux</a>
        
            <a href="/tags/arch/">Arch</a>
        
            <a href="/tags/backup/">Backup</a>
        
            <a href="/tags/automation/">Automation</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/post/fix-missing-formula-fonts-for-wps-office-on-linux/">
        
        
            <div class="article-image">
                <img src="/post/fix-missing-formula-fonts-for-wps-office-on-linux/header.5a9ccd94ce951dec8e0eb4d199714fbe_hu15503547491875252981.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Fix missing formula fonts for WPS Office on Linux"
                        
                        data-hash="md5-WpzNlM6VHeyODrTRmXFPvg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Fix missing formula fonts for WPS Office on Linux</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/install-linux-zen-kernel-on-arch-linux-to-improve-performance/">
        
        
            <div class="article-image">
                <img src="/post/install-linux-zen-kernel-on-arch-linux-to-improve-performance/header.06a2bc293767e549a4b64f70745b2cfa_hu4808927919241056216.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Install Linux ZEN kernel on Arch Linux to improve performance"
                        
                        data-hash="md5-BqK8KTdn5Umktk9wdFss&#43;g==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Install Linux ZEN kernel on Arch Linux to improve performance</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/arch-linux-install-guide-uefi--encrypted-lvm/">
        
        
            <div class="article-image">
                <img src="/post/arch-linux-install-guide-uefi--encrypted-lvm/header.5703acaab52d919d5bcffdf1559f9843_hu1059685424483156457.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Arch Linux install guide (UEFI &#43; encrypted LVM)"
                        
                        data-hash="md5-VwOsqrUtkZ1bz/3xVZ&#43;YQw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Arch Linux install guide (UEFI &#43; encrypted LVM)</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/automatic-server-backup-to-the-mega.nz-cloud/">
        
        
            <div class="article-image">
                <img src="/post/automatic-server-backup-to-the-mega.nz-cloud/header.a4913d71bbdf913635839c23ac357216_hu1926450258490511575.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Automatic server backup to the Mega.nz cloud"
                        
                        data-hash="md5-pJE9cbvfkTY1g5wjrDVyFg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Automatic server backup to the Mega.nz cloud</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/easy-deploy-openvpn-service-on-any-linux-server-using-custom-script/">
        
        
            <div class="article-image">
                <img src="/post/easy-deploy-openvpn-service-on-any-linux-server-using-custom-script/header.a6ffcc8140c308937484ec46a7029bf1_hu12471396964104110934.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Easy deploy OpenVPN service on any Linux server using custom script"
                        
                        data-hash="md5-pv/MgUDDCJN0hOxGpwKb8Q==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Easy deploy OpenVPN service on any Linux server using custom script</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="blogmorozcc/blogmorozcc.github.io"
    data-repo-id="R_kgDOHsfYjw"
    data-category="General"
    data-category-id="DIC_kwDOHsfYj84CbRdO"
    data-mapping="url"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('noborder_dark');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2016 - 
        
        2024 | ShiftHackZ
    </section>
    
    <section class="powerby">
        
        
        All rights reserved.
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a>
      <ol>
        <li><a href="#how-ab-update-system-works">How A/B Update System Works</a></li>
        <li><a href="#benefits-of-ab-update-system">Benefits of A/B Update System</a></li>
        <li><a href="#ab-backup-system">A/B Backup System</a></li>
      </ol>
    </li>
    <li><a href="#benefits-of-ab-specific-to-arch-linux">Benefits of A/B specific to Arch Linux</a>
      <ol>
        <li><a href="#improved-system-stability">Improved System Stability</a></li>
        <li><a href="#safety-in-testing-and-experimentation">Safety in Testing and Experimentation</a></li>
        <li><a href="#quicker-update-rollbacks">Quicker Update Rollbacks</a></li>
      </ol>
    </li>
    <li><a href="#downside-of-ab-update-and-backup-systems">Downside of A/B update and backup systems</a></li>
    <li><a href="#implementing-my-own-ab-update-and-backup-system">Implementing my own A/B update and backup system</a>
      <ol>
        <li><a href="#understanding-the-requirements">Understanding the requirements</a></li>
        <li><a href="#choosing-components">Choosing components</a></li>
        <li><a href="#partitioning-disk">Partitioning disk</a>
          <ol>
            <li><a href="#unlock-the-luks-container">Unlock the LUKS container.</a></li>
            <li><a href="#shrink-the-home-logical-volume">Shrink the home logical volume</a></li>
            <li><a href="#create-a-second-root-partition">Create a second root partition</a></li>
          </ol>
        </li>
        <li><a href="#configure-bootloader">Configure bootloader</a></li>
        <li><a href="#configure-fstab">Configure fstab</a></li>
        <li><a href="#make-partitions-identifiable">Make partitions identifiable</a></li>
        <li><a href="#implementing-backup-script">Implementing backup script</a>
          <ol>
            <li><a href="#identify-partitions-and-operation-mode">Identify partitions and operation mode</a></li>
            <li><a href="#perform-the-rsync-backup">Perform the rsync backup</a></li>
            <li><a href="#replace-the-fstab-file">Replace the fstab file</a></li>
            <li><a href="#create-linux-filesystem-symlinks">Create linux filesystem symlinks</a></li>
            <li><a href="#final-script-version">Final script version</a></li>
          </ol>
        </li>
        <li><a href="#running-updates">Running updates</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
